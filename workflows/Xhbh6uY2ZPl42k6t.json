{
  "active": true,
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Vaiables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking â€˜Test workflowâ€™": {
      "main": [
        [
          {
            "node": "Vaiables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Vaiables": {
      "main": [
        [
          {
            "node": "Get Pull Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Pull Request": {
      "main": [
        [
          {
            "node": "OpenAI1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI1": {
      "main": [
        [
          {
            "node": "Refine Results1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Refine Results1": {
      "main": [
        [
          {
            "node": "Filter by Priority",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Tool": {
      "ai_tool": [
        [
          {
            "node": "OpenAI1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-06-08T04:23:50.949Z",
  "id": "Xhbh6uY2ZPl42k6t",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "ì½”ë“œ ë¦¬ë·°",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ec464db8-8d7b-47d6-bef3-b19a2aa7f045",
        "responseMode": "lastNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        0,
        0
      ],
      "id": "68f5ca69-a038-47c1-b8ae-d407ea5f5297",
      "name": "Webhook",
      "webhookId": "ec464db8-8d7b-47d6-bef3-b19a2aa7f045"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        0,
        -160
      ],
      "id": "8c733cf2-18e9-431b-8d1c-07f4d0b9351a",
      "name": "When clicking â€˜Test workflowâ€™"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d1d73897-602e-4723-b015-d228ff51e5da",
              "name": "workflowUrl",
              "value": "http://localhost:5678/workflow/Z0PtaUOTDU8DLYTU",
              "type": "string"
            },
            {
              "id": "19806d7c-b6e4-4025-8641-ee5c44f93912",
              "name": "defaultPackage",
              "value": "com.example",
              "type": "string"
            },
            {
              "id": "9491cacd-de1e-4ca2-96bc-52268736ad8b",
              "name": "allowedPackages",
              "value": "[\"domain.model\", \"domain.event\", \"domain.exception\", \"application.service\", \"application.port.in\", \"application.port.out\", \"adapter.in.web\", \"adapter.in.event\", \"adapter.out.persistence\", \"adapter.out.event\", \"adapter.out.external\"]",
              "type": "array"
            },
            {
              "id": "7d9b085a-8884-4719-ad9c-b55d024bdfcc",
              "name": "allowedSuffixes",
              "value": "={\n  \"rules\": [\n    { \"package\": \"application.service\", \"suffix\": [\"CommandService\", \"QueryService\"] },\n    { \"package\": \"application.port.in\", \"suffix\": [\"CommandUseCase\", \"QueryUseCase\"] },\n    { \"package\": \"application.port.out\", \"suffix\": [\"Port\"] },\n    { \"package\": \"adapter.in.web\", \"suffix\": [\"Controller\"] },\n    { \"package\": \"adapter.out.persistence\", \"suffix\": [\"MasterMapper\", \"ReadMapper\"] },\n    { \"package\": \"adapter.out.external\", \"suffix\": [\"Adapter\"] }\n  ]\n}",
              "type": "object"
            },
            {
              "id": "8342b586-4dee-4aa2-9264-09eaa3acf34c",
              "name": "owner",
              "value": "={{ $json.body.owner }}",
              "type": "string"
            },
            {
              "id": "930a425a-b829-4a09-9c6a-d311ae1cca63",
              "name": "repo",
              "value": "={{ $json.body.repo }}",
              "type": "string"
            },
            {
              "id": "277fe591-ca54-4206-a52b-38cf85b441fc",
              "name": "pullNumber",
              "value": "={{ $json.body.pullNumber }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        220,
        0
      ],
      "id": "9f97d977-4b0e-424a-8a33-df5807cc0d1d",
      "name": "Vaiables"
    },
    {
      "parameters": {
        "url": "=https://api.github.com/repos/{{ $json.owner }}/{{ $json.repo }}/pulls/{{ $json.pullNumber }}/files",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        440,
        0
      ],
      "id": "b9ce29ef-76c1-4144-8c4f-6e82d7150e36",
      "name": "Get Pull Request",
      "credentials": {
        "githubApi": {
          "id": "OYItXu3TJaqpVZ8S",
          "name": "GitHub account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. ì „ì—­ë³€ìˆ˜ì—ì„œ ê¸°ì¤€ priority ê°€ì ¸ì˜¤ê¸°\nconst globalVars = $('Vaiables').first().json;\nconst thresholdPriority = (globalVars.priority || 'high').toLowerCase();\n\n// 2. ìš°ì„ ìˆœìœ„ ë§¤í•‘\nconst priorityLevels = {\n  critical: 3,\n  high: 2,\n  medium: 1,\n  low: 0\n};\n\nconst minLevel = priorityLevels[thresholdPriority] ?? 2; // fallback: high\n\n// 3. í•„í„°ë§ ìˆ˜í–‰\nconst results = [];\n\nfor (const item of items) {\n  const filteredReviews = (item.json.reviews || []).filter(r => {\n    const level = priorityLevels[r.priority?.toLowerCase()] ?? -1;\n    return level >= minLevel;\n  });\n\n  if (filteredReviews.length > 0) {\n    results.push({ json: { reviews: filteredReviews } });\n  }\n}\n\nreturn results;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1260,
        0
      ],
      "id": "c32a0cbf-c120-448b-8442-5ae67a49f049",
      "name": "Filter by Priority",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4.1",
          "mode": "list",
          "cachedResultName": "GPT-4.1"
        },
        "messages": {
          "values": [
            {
              "content": "=ë‹¹ì‹ ì€ ìˆ™ë ¨ëœ ì‹œë‹ˆì–´ ë°±ì—”ë“œ ê°œë°œìì…ë‹ˆë‹¤. ì•„ë˜ ì›ì¹™ì— ë”°ë¼ ì½”ë“œ ë¦¬ë·°ë¥¼ ìˆ˜í–‰í•˜ì„¸ìš”.\n\n## ğŸ¯ ë¦¬ë·° ëª©ì \nì‹¤ì§ˆì ì¸ **ë²„ê·¸** ë˜ëŠ” **ì ì¬ì ì¸ ë¬¸ì œì **ì´ ìˆëŠ” ì½”ë“œ ë¼ì¸ì—ë§Œ í”¼ë“œë°±ì„ ë‚¨ê¸°ì„¸ìš”.  \në‹¨ìˆœí•œ ì½”ë“œ ìŠ¤íƒ€ì¼, ì„±ëŠ¥ ê°œì„ , ë¦¬íŒ©í† ë§ ì•„ì´ë””ì–´ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.\n\n## âœ… í¬í•¨í•´ì•¼ í•˜ëŠ” í•­ëª© (ë°˜ë“œì‹œ ë¦¬ë·°í•´ì•¼ í•¨)\n- ì‹¤ì œ ë™ì‘ ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚¬ ê°€ëŠ¥ì„±ì´ ìˆëŠ” ì½”ë“œ\n- ì˜ˆì™¸ ì²˜ë¦¬ ëˆ„ë½ (null ì²´í¬, try-catch ë¯¸ì²˜ë¦¬ ë“±)\n- ë°ì´í„° ì†ì‹¤ ê°€ëŠ¥ì„± (ê°’ ë®ì–´ì“°ê¸°, ì‚­ì œ, ì¸ì½”ë”© ì˜¤ë¥˜ ë“±)\n- ë³´ì•ˆ ìœ„í—˜ (í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸, ì…ë ¥ ê²€ì¦ ëˆ„ë½ ë“±)\n- í•¨ìˆ˜ë‚˜ ë©”ì„œë“œê°€ ëª…ì‹œëœ ëª©ì ê³¼ ë‹¤ë¥´ê²Œ ì‚¬ìš©ëœ ê²½ìš°\n\n## âŒ ì œì™¸í•´ì•¼ í•˜ëŠ” í•­ëª© (ë¦¬ë·°í•˜ì§€ ë§ì•„ì•¼ í•¨)\n- ì½”ë“œ ìŠ¤íƒ€ì¼ (ë“¤ì—¬ì“°ê¸°, ì¤„ ë°”ê¿ˆ, import ì •ë ¬ ë“±)\n- ë³€ìˆ˜, ë©”ì„œë“œ, í´ë˜ìŠ¤ì˜ ë„¤ì´ë° í’ˆì§ˆ\n- í•¨ìˆ˜ê°€ ë„ˆë¬´ ê¸¸ë‹¤ê±°ë‚˜ ì‘ì€ ë©”ì„œë“œë¡œ ë‚˜ëˆ„ëŠ” ë“±ì˜ ë¦¬íŒ©í† ë§ ì œì•ˆ\n- ì„±ëŠ¥ ìµœì í™” ì•„ì´ë””ì–´ (ë£¨í”„ íš¨ìœ¨, ìºì‹± ë“±)\n- ì½”ë“œ êµ¬ì¡°ë‚˜ ì„¤ê³„ ë°©ì‹ ë³€ê²½ ì œì•ˆ\n\n## ğŸ·ï¸ Priority ë“±ê¸‰ (ë°˜ë“œì‹œ ì•„ë˜ ì¤‘ í•˜ë‚˜ë§Œ ì‚¬ìš©)\n| ê°’        | ì„¤ëª…                                                             |\n|-----------|------------------------------------------------------------------|\n| **critical** | ì¦‰ì‹œ ìˆ˜ì •í•˜ì§€ ì•Šìœ¼ë©´ ì‹œìŠ¤í…œ ì¥ì• Â·ë°ì´í„° ì†ì‹¤ì„ ìœ ë°œí•  ì¹˜ëª…ì  ë²„ê·¸ |\n| **high**     | ê¸°ëŠ¥ ì˜¤ë¥˜Â·ë°ì´í„° ë¶ˆì¼ì¹˜ ë“± ì‚¬ìš©ì ì˜í–¥ì´ í° ë¬¸ì œ              |\n| **medium**   | íŠ¹ì • ì¡°ê±´ì—ì„œë§Œ ë°œìƒí•˜ê±°ë‚˜ ìš°íšŒ ë°©ë²•ì´ ìˆëŠ” ë¬¸ì œ               |\n| **low**      | ê²½ë¯¸í•œ ë¡œì§ ì˜¤ë¥˜Â·ì˜ˆì™¸ì  ìƒí™©ì—ì„œë§Œ ì˜í–¥                        |\n\n## ğŸ“Œ ë§¤ìš° ì¤‘ìš”í•œ ì§€ì¹¨: ë¦¬ë·° ëŒ€ìƒ ë¼ì¸ ë²ˆí˜¸ êµ¬í•˜ê¸°\n\n`line`ì€ OpenAIê°€ ì§ì ‘ ê³„ì‚°í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.  \nëŒ€ì‹  ë¦¬ë·°ê°€ í•„ìš”í•œ ì½”ë“œ ì¤„ (`commentLine`)ì„ ì¶”ì¶œí•´ì£¼ë©´, OpenAI ì™¸ë¶€ì—ì„œ Code Tool(calculate_comment_line_number)ì´ patch ë‚´ì—ì„œ í•´ë‹¹ ì¤„ì„ ì°¾ì•„ ì‹¤ì œ ì¤„ ë²ˆí˜¸ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.\n\nCode Tool(calculate_comment_line_number)ì€ `query` ê°ì²´ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ì…ë ¥ì„ ë°›ìŠµë‹ˆë‹¤:\n\n```json\n{\n  \"patch\": \"ì…ë ¥ë°›ì€ patch ê°’ ê·¸ëŒ€ë¡œ ì „ë‹¬\",\n  \"commentLine\": \"if (!this.userId.equals(requestUserId))\"  // ë¦¬ë·° ëŒ€ìƒì´ ë˜ëŠ” ë¼ì¸\n}\n```\n\nê²°ê³¼ëŠ” ë¼ì¸ ë²ˆí˜¸ë¥¼ ë‚˜íƒ€ë‚´ëŠ” **ë‹¨ì¼ ë¬¸ìì—´(string)**ë¡œ ë°˜í™˜ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.\n\n## ì¶œë ¥ í˜•ì‹\nì•„ë˜ JSON ë°°ì—´ í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ê·¸ ì™¸ì˜ í…ìŠ¤íŠ¸ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.\n\n[\n  {\n    \"file\": \"íŒŒì¼ëª….java\",\n    \"line\": 7, // ë¦¬ë·°ê°€ í•„ìš”í•œ ë¼ì¸ ë²ˆí˜¸\n    \"comment\": \"ë¬¸ì œê°€ ë˜ëŠ” ì´ìœ ë¥¼ ê°„ë‹¨íˆ ì„¤ëª…\",\n    \"priority\": \"high\"\n  }\n]",
              "role": "system"
            },
            {
              "content": "=ë‹¤ìŒì€ PRì—ì„œ ë³€ê²½ëœ ì½”ë“œ jsonì…ë‹ˆë‹¤:\n\n{{ JSON.stringify($json, null, 2) }}\n\nì˜¤ì§ ì‹¤ì§ˆì ì¸ ì˜¤ë¥˜ì™€ ìœ„í—˜ì—ë§Œ ì§‘ì¤‘í•´ì£¼ì„¸ìš”."
            }
          ]
        },
        "jsonOutput": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        660,
        0
      ],
      "id": "5122749f-ec26-4c7e-965e-9b3ec9be9f9d",
      "name": "OpenAI1",
      "credentials": {
        "openAiApi": {
          "id": "mNBU5lSqo1M9WYgW",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const reviews = [];\n\nfor (const item of items) {\n  const content = item.json.message?.content;\n  if (!content) continue;\n\n  try {\n    // ë¬¸ìì—´ë¡œ ì˜¨ ê²½ìš° JSON íŒŒì‹±\n    const parsed = typeof content === 'string' ? JSON.parse(content) : content;\n\n    // case 1: content.reviewê°€ ë°°ì—´ì¸ ê²½ìš° (ì—¬ëŸ¬ ë¦¬ë·°)\n    if (Array.isArray(parsed.review)) {\n      reviews.push(...parsed.review);\n    }\n\n    // case 2: content ìì²´ê°€ ë‹¨ì¼ ë¦¬ë·° ê°ì²´ì¸ ê²½ìš°\n    else if (parsed?.file && parsed?.line && parsed?.comment) {\n      reviews.push(parsed);\n    }\n\n  } catch (error) {\n    console.log('âŒ JSON íŒŒì‹± ì˜¤ë¥˜:', error.message);\n  }\n}\n\nreturn [{ json: { reviews } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1040,
        0
      ],
      "id": "17f31581-f7b0-47e3-b35b-6032e3ed8fe3",
      "name": "Refine Results1"
    },
    {
      "parameters": {
        "name": "calculate_comment_line_number",
        "description": "Finds the comment line number in the file by scanning patch content for the review target code line.\n",
        "jsCode": "// query: OpenAIì—ì„œ ì „ë‹¬ë¨ (ë¬¸ìì—´ or undefined)\nif (typeof query === 'undefined' || !query || query.trim() === '{}') {\n  return 'NO_REVIEW';  // ë˜ëŠ” ë¹ˆ ë¬¸ìì—´ '' ë°˜í™˜ ê°€ëŠ¥\n}\n\nlet parsed;\ntry {\n  parsed = typeof query === 'string' ? JSON.parse(query) : query;\n} catch (err) {\n  return 'INVALID_QUERY';\n}\n\nif (!parsed.patch || !parsed.commentLine) {\n  return 'NO_REVIEW';\n}\n\nfunction getCommentLineNumber(patch, commentLine) {\n  const lines = patch.split('\\n');\n  let currentLine = 0;\n  let inHunk = false;\n\n  for (let i = 0; i < lines.length; i++) {\n    const line = lines[i];\n\n    if (line.startsWith('@@')) {\n      const match = line.match(/\\+(\\d+)(?:,(\\d+))?/);\n      if (!match) throw new Error(\"Invalid patch header\");\n      currentLine = parseInt(match[1], 10);\n      inHunk = true;\n      continue;\n    }\n\n    if (!inHunk) continue;\n\n    if (line.includes(commentLine)) {\n      return currentLine;\n    }\n\n    if (line.startsWith('+') && !line.startsWith('+++')) {\n      currentLine++;\n    } else if (!line.startsWith('-')) {\n      currentLine++;\n    }\n  }\n\n  throw new Error(\"Could not find comment line in patch\");\n}\n\ntry {\n  const { patch, commentLine } = parsed;\n  const lineNumber = getCommentLineNumber(patch, commentLine);\n  return lineNumber.toString();\n} catch (e) {\n  return 'LINE_NOT_FOUND'; // í˜¹ì€ e.message ë°˜í™˜ ê°€ëŠ¥\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.1,
      "position": [
        820,
        200
      ],
      "id": "679d4dde-9cc9-42e8-ad5a-6e4612e62808",
      "name": "Code Tool"
    }
  ],
  "pinData": {
    "When clicking â€˜Test workflowâ€™": [
      {
        "json": {
          "body": {
            "owner": "jsyang-dev",
            "repo": "hexagonal-example",
            "pullNumber": "1"
          }
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-06-14T01:36:58.976Z",
  "versionId": "a773b132-7c57-411e-a067-b463f8f7f1ab"
}